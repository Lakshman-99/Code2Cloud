# =============================================================================
# Traefik Middleware Configurations
# =============================================================================
# Middleware modifies requests/responses as they pass through Traefik
# These are reusable across multiple IngressRoutes
# =============================================================================

---
# Redirect HTTP to HTTPS
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: redirect-https
  namespace: traefik
spec:
  redirectScheme:
    scheme: https
    permanent: true

---
# Security headers for all responses
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: security-headers
  namespace: traefik
spec:
  headers:
    # Prevent clickjacking
    frameDeny: true
    # Prevent MIME type sniffing
    contentTypeNosniff: true
    # Enable XSS filter
    browserXssFilter: true
    # Referrer policy
    referrerPolicy: "strict-origin-when-cross-origin"
    # HSTS (comment out for testing with staging certs)
    # stsSeconds: 31536000
    # stsIncludeSubdomains: true

---
# Compress responses
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: compress
  namespace: traefik
spec:
  compress: {}

---
# Rate limiting (protect against abuse)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rate-limit
  namespace: traefik
spec:
  rateLimit:
    average: 100   # requests per second
    burst: 200     # max burst

---
# Strip prefix (useful for API versioning)
# Example: /api/v1/users -> /users (when routed to backend)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-api-prefix
  namespace: traefik
spec:
  stripPrefix:
    prefixes:
      - /api

---
# CORS middleware for API
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cors-api
  namespace: traefik
spec:
  headers:
    accessControlAllowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
    accessControlAllowHeaders:
      - Content-Type
      - Authorization
      - X-Requested-With
    accessControlAllowOriginList:
      - https://${DOMAIN}
      - https://${API_SUBDOMAIN}.${DOMAIN}
      - https://${APP_SUBDOMAIN}.${DOMAIN}
      - https://*.${DEPLOY_WILDCARD}.${DOMAIN}
    accessControlMaxAge: 86400
    accessControlAllowCredentials: true