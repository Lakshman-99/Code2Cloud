# =============================================================================
# Worker Service (Go)
# =============================================================================
# The Go worker handles:
#   - Processing deployment jobs from queue
#   - Building container images via BuildKit
#   - Pushing images to registry
#   - Creating/updating K8s deployments
#
# Needs RBAC permissions to manage resources in 'deployments' namespace
# =============================================================================

---
# ServiceAccount for worker
apiVersion: v1
kind: ServiceAccount
metadata:
  name: worker
  namespace: code2cloud

---
# Role with permissions in 'deployments' namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: code2cloud-worker
rules:
  # Manage deployments
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Manage services
  - apiGroups: [""]
    resources: ["services", "configmaps", "secrets", "serviceaccounts"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Manage ingresses and network policies
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses", "networkpolicies"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # View pods and logs
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]

---
# Bind role to worker ServiceAccount
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: code2cloud-worker
subjects:
  - kind: ServiceAccount
    name: worker
    namespace: code2cloud
roleRef:
  kind: ClusterRole
  name: code2cloud-worker
  apiGroup: rbac.authorization.k8s.io

---
# Worker ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: worker-config
  namespace: code2cloud
data:
  # Redis (same Redis as backend)
  REDIS_URL: "redis://redis:6379"
  QUEUE_NAME: "build-queue"

  # NestJS API (internal cluster URL â€” no need for external domain)
  API_BASE_URL: "http://backend:3000"
  WORKER_API_KEY: "${WORKER_API_KEY}"

  # BuildKit (running in default namespace)
  BUILDKIT_ADDR: "tcp://buildkitd.default.svc.cluster.local:1234"

  # Container Registry (running in registry namespace)
  REGISTRY_URL: "registry.registry.svc.cluster.local:5000"
  REGISTRY_INSECURE: "true"

  # Kubernetes
  K8S_NAMESPACE: "deployments"

  # Domain configuration
  BASE_DOMAIN: "${DEPLOY_WILDCARD}.${DOMAIN}"
  SERVER_IP: "${SERVER_IP}"

  # Build configuration
  BUILD_PLATFORM: "linux/arm64"
  BUILD_TIMEOUT: "600"

  # Worker identity
  WORKER_ID: "worker-1"
  WORKSPACE_PATH: "/tmp/builds"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: worker
  namespace: code2cloud
  labels:
    app: worker
    app.kubernetes.io/name: worker
    app.kubernetes.io/part-of: code2cloud
spec:
  replicas: 1
  selector:
    matchLabels:
      app: worker
  template:
    metadata:
      labels:
        app: worker
    spec:
      serviceAccountName: worker
      containers:
        - name: worker
          image: registry.registry.svc.cluster.local:5000/code2cloud-worker:latest
          imagePullPolicy: Always
          envFrom:
            - configMapRef:
                name: worker-config
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "1000m"
              memory: "512Mi"
          volumeMounts:
            - name: tmp
              mountPath: /tmp/builds
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 10Gi