// ─────────────────────────────────────────────────────────────
// Prisma Configuration
// ─────────────────────────────────────────────────────────────

generator client {
  provider = "prisma-client"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
  output   = "../generated/prisma"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DATABASE_DIRECT_URL")
}

// ─────────────────────────────────────────────────────────────
// User & Auth Models
// ─────────────────────────────────────────────────────────────

model User {
  id                  String        @id @default(uuid())
  email               String        @unique
  password            String?
  name                String?
  avatar              String?
  provider            String?
  hashedRefreshToken  String?

  gitAccounts         GitAccount[]
  projects            Project[]
  deployments         Deployment[]  @relation("UserDeployments")
  systemConfig        SystemConfig?

  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
}

model GitAccount {
  id               String   @id @default(uuid())
  provider         String   @default("github")
  providerId       String
  username         String
  avatarUrl        String?

  installationId   String?
  accessToken      String
  refreshToken     String?

  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([provider, providerId])
  @@index([userId])
}

// ─────────────────────────────────────────────────────────────
// Project Models
// ─────────────────────────────────────────────────────────────

model Project {
  id               String   @id @default(uuid())
  name             String   @unique

  // ─── UI Configuration ───────────────────────────
  language         String
  framework        String   @default("other")
  rootDirectory    String   @default("./")

  // ─── Build Settings ─────────────────────────────
  installCommand   String?
  buildCommand     String?
  runCommand       String?
  outputDirectory  String?

  // ─── Git Source Info ────────────────────────────
  gitRepoOwner     String
  gitRepoName      String
  gitRepoId        Int
  gitBranch        String
  gitCloneUrl      String
  gitRepoUrl       String

  // ─── Deployment Config ─────────────────────────
  configChanged    Boolean  @default(false)
  autoDeploy       Boolean  @default(true)
  onlineStatus     DomainDnsStatus  @default(PENDING)

  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ─── Relations ─────────────────────────────────
  envVars          EnvironmentVariable[]
  deployments      Deployment[]
  domains          Domain[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
}

model EnvironmentVariable {
  id         String            @id @default(uuid())
  key        String
  value      String            @db.Text
  targets    EnvironmentType[] @default([PRODUCTION, PREVIEW, DEVELOPMENT])

  projectId  String
  project    Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  @@unique([projectId, key])
  @@index([projectId])
}

// ─────────────────────────────────────────────────────────────
// Deployment Models
// ─────────────────────────────────────────────────────────────

enum DeploymentStatus {
  QUEUED
  BUILDING
  DEPLOYING
  READY
  FAILED
  CANCELED
  EXPIRED
}

enum EnvironmentType {
  PRODUCTION
  PREVIEW
  DEVELOPMENT
}

enum DomainDnsStatus {
  ACTIVE
  INACTIVE
  PENDING
  VERIFYING
  ERROR
}

model Deployment {
  id                String           @id @default(uuid())
  status            DeploymentStatus @default(QUEUED)
  environment       EnvironmentType  @default(PRODUCTION)

  // ─── Git Metadata ───────────────────────────────
  commitHash        String
  commitMessage     String?
  commitAuthor      String?
  branch            String

  // ─── Machine Info ───────────────────────────────
  machineCpu        Float            @default(1.0)
  machineRam        Int              @default(512)
  machineStorage    Int              @default(8192)
  machineOS         String           @default("Ubuntu 22.04 LTS")

  // ─── Infrastructure ─────────────────────────────
  containerImage    String?
  deploymentUrl     String?
  deploymentRegion  String           @default("us-east-1")
  logs              LogEntry[]       

  // ─── Timing ─────────────────────────────────────
  startedAt         DateTime         @default(now())
  finishedAt        DateTime?
  duration          Int?

  // ─── Relations ──────────────────────────────────
  projectId         String
  project           Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  initiatorId       String?
  initiator         User?            @relation("UserDeployments", fields: [initiatorId], references: [id])

  @@index([projectId])
  @@index([status])
}

// ─────────────────────────────────────────────────────────────
// Domain Models
// ─────────────────────────────────────────────────────────────

model Domain {
  id         String           @id @default(uuid())
  name       String           @unique
  status     DomainDnsStatus  @default(PENDING)
  type       EnvironmentType  @default(PRODUCTION)
  error      String?          @db.Text

  projectId  String
  project    Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@index([projectId])
  @@index([status])
}

// ─────────────────────────────────────────────────────────────
// System Config Models
// ─────────────────────────────────────────────────────────────

model SystemConfig {
  id        String   @id @default(uuid())
  userId    String   @unique

  // --- General ---
  defaultRegion       String @default("us-east-1")
  maxConcurrentBuilds Int    @default(1)
  logRetentionDays    Int    @default(1)

  // --- Lifecycle ---
  turboMode           Boolean @default(false)
  globalTTLMinutes    Int     @default(5) // Auto-destruct timer
  autoDeploy          Boolean @default(true)

  // --- Notifications ---
  slackWebhook        String? 
  emailDeployFailed   Boolean @default(true)
  emailDeploySuccess  Boolean @default(true)

  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─────────────────────────────────────────────────────────────
// LOGGING MODELS (NEW)
// ─────────────────────────────────────────────────────────────

enum LogSource {
  BUILD    // Logs from the Docker build process
  RUNTIME  // stdout/stderr from the running container
  SYSTEM   // Kubernetes/Infrastructure events
}

model LogEntry {
  id           String      @id @default(uuid())
  
  deploymentId String
  deployment   Deployment  @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  source       LogSource
  timestamp    DateTime    @default(now())
  message      String      @db.Text

  @@index([deploymentId, source, timestamp])
}