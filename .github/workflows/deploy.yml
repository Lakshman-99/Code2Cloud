# =============================================================================
# Code2Cloud CI/CD Pipeline
# =============================================================================
# Automatically builds and deploys changed apps to the K8s cluster.
#
# How it works:
#   1. Detects which apps changed based on file paths
#   2. SSHs into the server via appleboy/ssh-action
#   3. Pulls latest code
#   4. Builds changed apps using BuildKit → pushes to internal registry
#   5. Restarts only the affected K8s deployments
#
# Required GitHub Secrets:
#   SSH_HOST          - Server IP address
#   SSH_USER          - SSH username (e.g., ubuntu)
#   SSH_PRIVATE_KEY   - SSH private key for authentication
#   DATABASE_URL      - PostgreSQL connection string (for API build)
#   DATABASE_DIRECT_URL - PostgreSQL direct connection string (for API build)
#   DOMAIN            - Main domain (e.g., code2cloud.lakshman.me)
#   API_SUBDOMAIN     - API subdomain (e.g., api)
# =============================================================================

name: Deploy

on:
  push:
    branches: [main]
    paths:
      - "apps/web/**"
      - "apps/api/**"
      - "apps/worker/**"
      - "packages/**"
  workflow_dispatch:
    inputs:
      deploy_all:
        description: "Deploy all apps (ignore change detection)"
        type: boolean
        default: false
      deploy_web:
        description: "Deploy web"
        type: boolean
        default: false
      deploy_api:
        description: "Deploy api"
        type: boolean
        default: false
      deploy_worker:
        description: "Deploy worker"
        type: boolean
        default: false

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Detect which apps have changed
  # ===========================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.set-outputs.outputs.web }}
      api: ${{ steps.set-outputs.outputs.api }}
      worker: ${{ steps.set-outputs.outputs.worker }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: changes
        if: github.event_name == 'push'
        with:
          filters: |
            web:
              - 'apps/web/**'
              - 'packages/**'
            api:
              - 'apps/api/**'
              - 'packages/**'
            worker:
              - 'apps/worker/**'

      - name: Set outputs
        id: set-outputs
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.deploy_all }}" == "true" ]]; then
              echo "web=true" >> $GITHUB_OUTPUT
              echo "api=true" >> $GITHUB_OUTPUT
              echo "worker=true" >> $GITHUB_OUTPUT
            else
              echo "web=${{ inputs.deploy_web }}" >> $GITHUB_OUTPUT
              echo "api=${{ inputs.deploy_api }}" >> $GITHUB_OUTPUT
              echo "worker=${{ inputs.deploy_worker }}" >> $GITHUB_OUTPUT
            fi
          else
            echo "web=${{ steps.changes.outputs.web }}" >> $GITHUB_OUTPUT
            echo "api=${{ steps.changes.outputs.api }}" >> $GITHUB_OUTPUT
            echo "worker=${{ steps.changes.outputs.worker }}" >> $GITHUB_OUTPUT
          fi

  # ===========================================================================
  # Deploy changed apps
  # ===========================================================================
  deploy:
    name: Build & Deploy
    needs: detect-changes
    runs-on: ubuntu-latest
    if: |
      needs.detect-changes.outputs.web == 'true' ||
      needs.detect-changes.outputs.api == 'true' ||
      needs.detect-changes.outputs.worker == 'true'
    steps:
      - name: Summary of changes
        run: |
          echo "## Deployment Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| App | Deploy |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Web | ${{ needs.detect-changes.outputs.web }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ needs.detect-changes.outputs.api }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | ${{ needs.detect-changes.outputs.worker }} |" >> $GITHUB_STEP_SUMMARY

      - name: Build and deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 30m
          script: |
            set -euo pipefail

            DEPLOY_WEB="${{ needs.detect-changes.outputs.web }}"
            DEPLOY_API="${{ needs.detect-changes.outputs.api }}"
            DEPLOY_WORKER="${{ needs.detect-changes.outputs.worker }}"
            DATABASE_URL="${{ secrets.DATABASE_URL }}"
            DATABASE_DIRECT_URL="${{ secrets.DATABASE_DIRECT_URL }}"
            DOMAIN="${{ secrets.DOMAIN }}"
            API_SUBDOMAIN="${{ secrets.API_SUBDOMAIN }}"

            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            # =================================================================
            # Configuration
            # =================================================================
            REPO_URL="https://github.com/Lakshman-99/Code2Cloud.git"
            BRANCH="main"
            BUILD_DIR="/tmp/code2cloud-ci-build"
            REGISTRY_IP=$(sudo kubectl get svc registry -n registry -o jsonpath='{.spec.clusterIP}')
            BUILDKIT_IP=$(sudo kubectl get svc buildkitd -n default -o jsonpath='{.spec.clusterIP}')

            echo "══════════════════════════════════════════════════════════════"
            echo "  Code2Cloud CI/CD Deploy"
            echo "══════════════════════════════════════════════════════════════"
            echo "  Registry:  ${REGISTRY_IP}:5000"
            echo "  BuildKit:  ${BUILDKIT_IP}:1234"
            echo "  Web:       ${DEPLOY_WEB}"
            echo "  API:       ${DEPLOY_API}"
            echo "  Worker:    ${DEPLOY_WORKER}"
            echo "══════════════════════════════════════════════════════════════"

            # =================================================================
            # Clone / Update repository
            # =================================================================
            if [ -d "${BUILD_DIR}/repo/.git" ]; then
              echo "→ Updating existing repo..."
              cd ${BUILD_DIR}/repo
              git fetch origin
              git reset --hard origin/${BRANCH}
              git clean -fdx
            else
              echo "→ Cloning repository..."
              sudo rm -rf ${BUILD_DIR}
              mkdir -p ${BUILD_DIR}
              git clone --branch ${BRANCH} --depth 1 ${REPO_URL} ${BUILD_DIR}/repo
            fi

            cd ${BUILD_DIR}/repo
            COMMIT_SHA=$(git rev-parse --short HEAD)
            echo "→ Building from commit: ${COMMIT_SHA}"

            # =================================================================
            # Build and deploy function
            # =================================================================
            build_and_deploy() {
              local APP_NAME=$1
              local DOCKERFILE_DIR=$2
              local IMAGE_NAME=$3
              local K8S_DEPLOYMENT=$4
              shift 4

              echo ""
              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
              echo "  Building: ${APP_NAME}"
              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

              # Build the build args array
              local BUILD_ARGS=""
              for arg in "$@"; do
                BUILD_ARGS="${BUILD_ARGS} --opt build-arg:${arg}"
              done

              echo "→ Running buildctl..."
              sudo buildctl --addr tcp://${BUILDKIT_IP}:1234 build \
                --frontend dockerfile.v0 \
                --local context=. \
                --local dockerfile=${DOCKERFILE_DIR} \
                ${BUILD_ARGS} \
                --output type=image,name=${REGISTRY_IP}:5000/${IMAGE_NAME}:latest,push=true,registry.insecure=true

              if [ $? -ne 0 ]; then
                echo "✗ Build failed for ${APP_NAME}"
                return 1
              fi

              echo "→ Tagging with commit SHA: ${COMMIT_SHA}"
              sudo buildctl --addr tcp://${BUILDKIT_IP}:1234 build \
                --frontend dockerfile.v0 \
                --local context=. \
                --local dockerfile=${DOCKERFILE_DIR} \
                ${BUILD_ARGS} \
                --output type=image,name=${REGISTRY_IP}:5000/${IMAGE_NAME}:${COMMIT_SHA},push=true,registry.insecure=true \
              || echo "→ Warning: SHA tag failed, :latest was pushed successfully"

              echo "→ Restarting deployment: ${K8S_DEPLOYMENT}"
              sudo kubectl rollout restart deployment/${K8S_DEPLOYMENT} -n code2cloud
              sudo kubectl rollout status deployment/${K8S_DEPLOYMENT} -n code2cloud --timeout=300s

              echo "✓ ${APP_NAME} deployed successfully (${COMMIT_SHA})"
            }

            # =================================================================
            # Build changed apps
            # =================================================================
            FAILED=()

            if [ "${DEPLOY_API}" = "true" ]; then
              build_and_deploy "API (NestJS)" "apps/api" "code2cloud-backend" "backend" \
                "DATABASE_URL=${DATABASE_URL}" \
                "DATABASE_DIRECT_URL=${DATABASE_DIRECT_URL}" \
              || FAILED+=("api")
            fi

            if [ "${DEPLOY_WEB}" = "true" ]; then
              mkdir -p apps/web/public
              build_and_deploy "Web (Next.js)" "apps/web" "code2cloud-frontend" "frontend" \
                "NEXT_PUBLIC_API_URL=https://${API_SUBDOMAIN}.${DOMAIN}" \
                "NEXT_PUBLIC_APP_URL=https://${DOMAIN}" \
              || FAILED+=("web")
            fi

            if [ "${DEPLOY_WORKER}" = "true" ]; then
              build_and_deploy "Worker (Go)" "apps/worker" "code2cloud-worker" "worker" \
              || FAILED+=("worker")
            fi

            # =================================================================
            # Summary
            # =================================================================
            echo ""
            echo "══════════════════════════════════════════════════════════════"
            if [ ${#FAILED[@]} -eq 0 ]; then
              echo "  ✓ All deployments successful!"
            else
              echo "  ✗ Failed deployments: ${FAILED[*]}"
              exit 1
            fi
            echo "══════════════════════════════════════════════════════════════"

      - name: Post deployment summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Result" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
